version: '3.8'

services:
  # 1. The AI Brain (Ollama)
  ollama-agent:
    image: ollama/ollama:latest
    container_name: ollama
    restart: always
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - ai_net

  # 2. The Logic/UI (Flowise)
  flowise-agent:
    image: flowiseai/flowise:latest
    container_name: flowise
    restart: always
    ports:
      - "4124:3000"
    volumes:
      - flowise_data:/root/.flowise
    environment:
      - PORT=3000
    networks:
      - ai_net
    depends_on:
      - ollama

  # 3. The "Auto-Installer" (Downloads qwen2.5:0.5b automatically)
  ollama-model-loader-agent:
    image: curlimages/curl
    container_name: ollama_model_loader
    restart: on-failure
    networks:
      - ai_net
    depends_on:
      - ollama
    command: >
      sh -c "echo '⏳ Waiting for Ollama to start...' &&
             sleep 10 &&
             echo '⬇️  Requesting model download (qwen2.5:0.5b)...' &&
             curl -X POST http://ollama:11434/api/pull -d '{\"name\": \"qwen2.5:0.5b\"}' &&
             echo '✅ Model download request sent! (Check Ollama logs for progress)'"

  #-------------------------------------------------------------------------------
  # 4. ¡NUEVO! CAJA DE DESARROLLO PARA BENTOML (SOLO HERRAMIENTAS)
  #-------------------------------------------------------------------------------
  bentoml_devbox:
    container_name: bentoml_dev_tools
    restart: always
    
    # Construye la imagen con nuestro Dockerfile de desarrollo.
    build:
      context: .
      dockerfile: Dockerfile.bento.dev
      
    # ¡LA CLAVE! Monta tu carpeta de proyectos existente dentro del contenedor.
    # Cualquier cambio que hagas en tu máquina en 'mlflow-projects' se reflejará
    # dentro del contenedor en '/workspace' y viceversa.
    volumes:
      - ./mlflow-projects:/workspace
      
    # Conecta el contenedor a la red para que, si es necesario,
    # pueda comunicarse con otros servicios como ollama.
    networks:
      - ai_net

# Definición de todos los volúmenes que usamos en el stack.
volumes:
  ollama_data:
  flowise_data:

# Definición de la red compartida.
networks:
  ai_net:
    driver: bridge
